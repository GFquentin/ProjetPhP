#### Par défaut tout est bloqué ####

## On drop tout le trafic entrant.

iptables -P INPUT DROP

## On drop tout le trafic sortant.

iptables -P OUTPUT DROP

## On allow le forward.

iptables -P FORWARD DROP


###### SSH OK pour PC Admin réseau principal ########

# Autorise le SSH sur les SRV depuis le poste admin 0.10 #
iptables -A FORWARD -p tcp -s 192.168.0.10 -d 192.168.0.100 --sport 1024:65535 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.0.100 -d 192.168.0.10 --sport 22 --dport 1024:65535 -m state --state NEW,ESTABLISHED -j ACCEPT

iptables -A FORWARD -p tcp -s 192.168.0.10 -d 192.168.1.101 --sport 1024:65535 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.1.101 -d 192.168.0.10 --sport 22 --dport 1024:65535 -m state --state NEW,ESTABLISHED -j ACCEPT

iptables -A INPUT -p tcp -s 192.168.0.10 -d 192.168.0.254 --sport 1024:65535 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -s 192.168.0.254 -d 192.168.0.10 --sport 22 --dport 1024:65535 -m state --state NEW,ESTABLISHED -j ACCEPT


########## Web OK pour réseau 192.168.2.0/24  ###################
iptables -A FORWARD -p tcp -s 192.168.2.0/24 -d 192.168.1.101 --sport 1024:65535 --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.1.101 -d 192.168.2.0/24 --sport 80 --dport 1024:65535 -m state --state NEW,ESTABLISHED -j ACCEPT


######### DNS OK pour réseau 192.168.2.0/24 ########
iptables -A FORWARD -p udp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -p udp -s 192.168.0.100 -d 192.168.2.0/24 --sport 53 --dport 1024:65535 -m state --state NEW,ESTABLISHED -j ACCEPT


####### Autoriser toutes communications entre 192.168.0-1-2.0/24  et 172.31.0.0/16 pour l'accès Internet #######
iptables -A FORWARD -i eth0 -j ACCEPT
iptables -A FORWARD -o eth0 -j ACCEPT


###### Autoriser les communications SMB pour tous ##########
# NameService
iptables -A FORWARD -p udp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 135 -j ACCEPT
iptables -A FORWARD -p udp -s 192.168.0.100 -d 192.168.2.0/24 --sport 135 --dport 1024:65535 -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 135 -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.0.100 -d 192.168.2.0/24 --sport 135 --dport 1024:65535 -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 137 -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.0.100 -d 192.168.2.0/24 --sport 137 --dport 1024:65535 -j ACCEPT
iptables -A FORWARD -p udp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 137 -j ACCEPT
iptables -A FORWARD -p udp -s 192.168.0.100 -d 192.168.2.0/24 --sport 137 --dport 1024:65535 -j ACCEPT
iptables -A FORWARD -p udp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 138 -j ACCEPT
iptables -A FORWARD -p udp -s 192.168.0.100 -d 192.168.2.0/24 --sport 138 --dport 1024:65535 -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 139 -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.0.100 -d 192.168.2.0/24 --sport 139 --dport 1024:65535 -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 445 -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.0.100 -d 192.168.2.0/24 --sport 445 --dport 1024:65535 -j ACCEPT
iptables -A FORWARD -p udp -s 192.168.2.0/24 -d 192.168.0.100 --sport 1024:65535 --dport 445 -j ACCEPT
iptables -A FORWARD -p udp -s 192.168.0.100 -d 192.168.2.0/24 --sport 445 --dport 1024:65535 -j ACCEPT


##### On interdit tout #####

iptables -A INPUT -j DROP
iptables -A OUTPUT -j DROP
iptables -A FORWARD -j DROP